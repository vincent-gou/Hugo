---
title: "Varaiablisation des annotations dans Grafana"
authors:
  - Vincent Gourrierec
date: 2020-12-09
tags: ["grafana","influxdb"]
categories: ["posts"]
draft: false
keywords:
- vincent-gou.fr
- vincent gourrierec
- saint nazaire
- loki
- promtail
- grafana
- influxdb
- windows
- nssm
---
:imagesdir: ../../images


== Objectifs

* Permettre d'afficher les annotations liées à une variable sur un dashboard

== Pré-requis

* Disposer d'un dashboard par client
* Disposer d'un dashboard d'administration de tous les clients avec une variable permettant de cibler le critère de sélection.

== Préparation

=== Dashboard client

Dans le menu "Dashboard settings" / Annotations, sélectionnez la ligne par défaut : "Annotations & Alerts (Built-in)" ou créez une nouvelle annotation.

image::GRAFANA_Annotation_Variables.fr-00423.png[500,400,float="right",align="center"]

Le principe ici étant de définir les tags qui seront utilisés pour afficher les annotations crées dans l'API Grafana et affichées dans ce Dashboard.

Vous pouvez donc définir plusieurs tags "générique"et au moins un spécifique.


NOTE: Pensez à cliquer sur "Update" puis à sauvegarder le dashboard.

WARNING: Si vous cochez "Match any", la présence de n'importe lequel des tags affichera l'annotation. Ce n'est l'effet désiré, donc ne cochez cette option que si nécessaire.


Par exemple:

[source,bash]
----
extranet
editeur
client:client_xyz
----

=== Dashboard d'administration

==== Création d'une variable

Si vous n'avez pas de variable permettant de filter votre dashboard, créez en une.

Dans le menu "Dashboard settings" / Variables, ajoutez une nouvelle variable.

Renseignez les informations d'affichage et la requete de sélection:

image::GRAFANA_Annotation_Variables.fr-ae422.png[500,400,float="right",align="center"]

Puis cliquez sur "Update" et "Save Dashboard"

Un bouton contenant la liste des valeurs issues de la requête sera disponible sur votre Dashboard:

image::GRAFANA_Annotation_Variables.fr-0bb4d.png[500,400,float="right",align="center"]


image::GRAFANA_Annotation_Variables.fr-270ca.png[500,400,float="right",align="center"]

==== Création d'un bouton de sélection des annotations utilisant une partie des tags des dashboard client

Dans le menu "Dashboard settings" / Annotations, sélectionnez la ligne par défaut : "Annotations & Alerts (Built-in)" ou créez une nouvelle annotation.

image::GRAFANA_Annotation_Variables.fr-9044a.png[500,400,float="right",align="center"]

Le principe ici étant de définir une annotation utilisant les tags des dashboard client sans le tag spécifique du client.

Par exemple:

[source,bash]
----
extranet
editeur
----

==== Création d'un bouton de sélection des annotations utilisant les tags et une variable définie dans le dashboard d'administration

Dans le menu "Dashboard settings" / Annotations, sélectionnez la ligne par défaut : "Annotations & Alerts (Built-in)" ou créez une nouvelle annotation.

image::GRAFANA_Annotation_Variables.fr-fc253.png[500,400,float="right",align="center"]

Le principe ici étant de définir une annotation utilisant les tags des dashboard client avec le tag spécifique du client spécifié.

Par exemple:

[source,bash]
----
extranet
editeur
client:$client
----

== Processus de création d'un annotation

=== Création d'une annotation sur Dashboard client

Depuis le dashboard client, cliquez sur une zone d'un graphique puis cliquez:

image::GRAFANA_Annotation_Variables.fr-588b0.png[500,400,float="right",align="center"]

Ensuite renseignez le message ainsi que les tags propre au client, par exemple:

[source,bash]
----
extranet
editeur
client:client_xyz
----

L'annotation devrait etre visible sur le graphique et les autres graphiques du Dashboard s'il y en a:

image::GRAFANA_Annotation_Variables.fr-ef2cd.png[500,400,float="right",align="center"]

Contenu de l'annotation lorsque la souris pointe sur celle-ci:

image::GRAFANA_Annotation_Variables.fr-2287a.png[500,400,float="right",align="center"]



=== Création d'une annotation sur Dashboard d'administration des clients
